======================================================================
PYTHON FILES FROM: C:\Users\hilto\pinkbison_studio\tests\unit\models
GENERATED: 01/20/2026 11:36:34
======================================================================

######################################################################
# FILE: C:\Users\hilto\pinkbison_studio\tests\unit\models\test_model_client.py
# MODIFIED: 01/16/2026 20:48:02
######################################################################

"""
Test ModelClient functionality.
"""

import pytest
from unittest.mock import Mock, patch
from models.model_client import ModelClient
from models.exceptions import (
    ModelTimeoutError,
    ModelResponseError,
    ModelServerError,
    ModelConnectionError,
)


class TestModelClient:
    """Test ModelClient class"""
    
    def setup_method(self):
        """Create client for each test"""
        self.client = ModelClient(
            model_url="http://test:8000/v1/chat/completions",
            timeout=5,
            max_retries=3
        )
    
    @patch('models.model_client.requests.post')
    def test_complete_success(self, mock_post):
        """Verify successful completion"""
        # Mock successful response
        mock_response = Mock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "choices": [
                {"message": {"content": "Test response"}}
            ]
        }
        mock_post.return_value = mock_response
        
        result = self.client.complete(
            messages=[{"role": "user", "content": "Test"}]
        )
        
        assert result == "Test response"
        assert mock_post.called
    
    @patch('models.model_client.requests.post')
    def test_complete_simple(self, mock_post):
        """Verify simple completion interface"""
        mock_response = Mock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "choices": [
                {"message": {"content": "Simple response"}}
            ]
        }
        mock_post.return_value = mock_response
        
        result = self.client.complete_simple("Test prompt")
        
        assert result == "Simple response"
        # Verify messages were constructed correctly
        call_args = mock_post.call_args
        payload = call_args[1]['json']
        assert payload['messages'] == [{"role": "user", "content": "Test prompt"}]
    
    @patch('models.model_client.requests.post')
    @patch('models.model_client.time.sleep')  # Mock sleep to speed up test
    def test_timeout_with_retry(self, mock_sleep, mock_post):
        """Verify timeout triggers retry"""
        import requests
        mock_post.side_effect = requests.Timeout("Timeout")
        
        with pytest.raises(ModelTimeoutError) as exc_info:
            self.client.complete(
                messages=[{"role": "user", "content": "Test"}]
            )
        
        # Should retry 3 times
        assert mock_post.call_count == 3
        assert "timed out after 3 attempts" in str(exc_info.value)
    
    @patch('models.model_client.requests.post')
    def test_empty_response_error(self, mock_post):
        """Verify empty response raises error"""
        mock_response = Mock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "choices": [
                {"message": {"content": ""}}
            ]
        }
        mock_post.return_value = mock_response
        
        with pytest.raises(ModelResponseError) as exc_info:
            self.client.complete(
                messages=[{"role": "user", "content": "Test"}]
            )
        
        assert "Empty response content" in str(exc_info.value)
    
    @patch('models.model_client.requests.post')
    def test_invalid_response_structure(self, mock_post):
        """Verify invalid response structure raises error"""
        mock_response = Mock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "invalid": "structure"
        }
        mock_post.return_value = mock_response
        
        with pytest.raises(ModelResponseError):
            self.client.complete(
                messages=[{"role": "user", "content": "Test"}]
            )
    
    @patch('models.model_client.requests.post')
    def test_connection_error(self, mock_post):
        """Verify connection error is handled"""
        import requests
        mock_post.side_effect = requests.ConnectionError("Connection failed")
        
        with pytest.raises(ModelConnectionError) as exc_info:
            self.client.complete(
                messages=[{"role": "user", "content": "Test"}]
            )
        
        assert "Failed to connect" in str(exc_info.value)
    
    @patch('models.model_client.requests.post')
    @patch('models.model_client.time.sleep')
    def test_server_error_with_retry(self, mock_sleep, mock_post):
        """Verify 5xx errors trigger retry"""
        import requests
        
        # Create response that will trigger HTTPError
        mock_response = Mock()
        mock_response.status_code = 500
        mock_response.text = "Internal server error"
        
        # Make raise_for_status raise an HTTPError
        http_error = requests.HTTPError("500 Server Error")
        http_error.response = mock_response
        mock_response.raise_for_status.side_effect = http_error
        
        mock_post.return_value = mock_response
        
        with pytest.raises(ModelServerError):
            self.client.complete(
                messages=[{"role": "user", "content": "Test"}]
            )
        
        # Should retry on 5xx errors
        assert mock_post.call_count == 3
    
    @patch('models.model_client.requests.post')
    def test_custom_parameters(self, mock_post):
        """Verify custom parameters are passed correctly"""
        mock_response = Mock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "choices": [
                {"message": {"content": "Response"}}
            ]
        }
        mock_post.return_value = mock_response
        
        self.client.complete(
            messages=[{"role": "user", "content": "Test"}],
            temperature=0.9,
            max_tokens=500
        )
        
        # Verify parameters were passed
        call_args = mock_post.call_args
        payload = call_args[1]['json']
        assert payload['temperature'] == 0.9
        assert payload['max_tokens'] == 500

----------------------------------------------------------------------

######################################################################
# FILE: C:\Users\hilto\pinkbison_studio\tests\unit\models\__init__.py
# MODIFIED: 01/16/2026 20:46:20
######################################################################

# Empty file for package recognition

----------------------------------------------------------------------

======================================================================
SUMMARY: 2 files combined
======================================================================
